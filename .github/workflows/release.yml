name: Release JS/TS SDK

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - prepatch
          - preminor
          - premajor
      prerelease_type:
        description: "Pre-release type (used when version is prepatch/preminor/premajor)"
        type: choice
        default: ""
        options:
          - ""
          - alpha
          - beta
          - rc
      dry_run:
        description: "Dry run (skip publish and git push)"
        type: boolean
        default: false
      confirm_major:
        description: "Type RELEASE MAJOR to confirm a major or premajor release"
        required: false
        default: ""

permissions:
  contents: write
  id-token: write # Required for npm provenance via OIDC
  pull-requests: write

concurrency:
  group: js-sdk-release
  cancel-in-progress: false

jobs:
  release-js-sdk:
    runs-on: ubuntu-latest
    environment: protected branches
    steps:
      - name: Verify branch
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "‚ùå Error: Releases can only be triggered from main branch"
            echo "Current ref: ${{ github.ref }}"
            exit 1
          fi
      - name: Confirm major release
        if: ${{ inputs.version == 'major' || inputs.version == 'premajor' }}
        run: |
          if [ "${{ inputs.confirm_major }}" != "RELEASE MAJOR" ]; then
            echo "‚ùå For major/premajor releases, set confirm_major to RELEASE MAJOR"
            exit 1
          fi
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_ACCESS_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: "https://registry.npmjs.org"

      - name: Configure Git
        env:
          GH_ACCESS_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
        run: |
          git config user.name "langfuse-bot"
          git config user.email "langfuse-bot@langfuse.com"

          echo "$GH_ACCESS_TOKEN" | gh auth login --with-token
          gh auth setup-git

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify lockfile integrity
        run: |
          echo "Verifying pnpm lockfile has not been tampered with..."
          git diff --exit-code pnpm-lock.yaml || {
            echo "‚ùå Error: pnpm-lock.yaml was modified during install"
            exit 1
          }

      - name: Determine release parameters
        id: release-params
        run: |
          version_type="${{ inputs.version }}"

          if [ "$version_type" = "prepatch" ] || [ "$version_type" = "preminor" ] || [ "$version_type" = "premajor" ]; then
            prerelease_type="${{ inputs.prerelease_type }}"
            if [ -z "$prerelease_type" ]; then
              echo "‚ùå Error: prerelease_type must be specified when version is prepatch/preminor/premajor"
              exit 1
            fi

            current_version=$(node -p "require('./package.json').version")
            base_version="${current_version%%-*}"
            IFS='.' read -r major minor patch <<< "$base_version"

            if echo "$current_version" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+-'; then
              current_is_prerelease="true"
            else
              current_is_prerelease="false"
            fi

            case "$version_type" in
              premajor)
                if [ "$current_is_prerelease" = "true" ] && [ "$minor" -eq 0 ] && [ "$patch" -eq 0 ]; then
                  target_major=$major
                else
                  target_major=$((major + 1))
                fi
                target_minor=0
                target_patch=0
                ;;
              preminor)
                target_major=$major
                if [ "$current_is_prerelease" = "true" ] && [ "$patch" -eq 0 ] && [ "$minor" -gt 0 ]; then
                  target_minor=$minor
                else
                  target_minor=$((minor + 1))
                fi
                target_patch=0
                ;;
              prepatch)
                target_major=$major
                target_minor=$minor
                if [ "$current_is_prerelease" = "true" ] && [ "$patch" -gt 0 ]; then
                  target_patch=$patch
                else
                  target_patch=$((patch + 1))
                fi
                ;;
            esac

            target_base_version="${target_major}.${target_minor}.${target_patch}"
            if [ "$current_is_prerelease" = "true" ] && [ "$base_version" = "$target_base_version" ]; then
              release_increment="prerelease"
            else
              release_increment="$version_type"
            fi

            echo "release_increment=${release_increment}" >> $GITHUB_OUTPUT
            echo "pre_release_flag=--preRelease=${prerelease_type}" >> $GITHUB_OUTPUT
            echo "tag=${prerelease_type}" >> $GITHUB_OUTPUT
          else
            echo "release_increment=${version_type}" >> $GITHUB_OUTPUT
            echo "pre_release_flag=" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Build all packages
        run: pnpm build

      - name: Verify build artifacts
        run: |
          echo "Verifying all packages have dist folders..."
          for pkg in packages/*/package.json; do
            pkg_dir=$(dirname $pkg)
            pkg_name=$(basename $pkg_dir)
            if [ ! -d "$pkg_dir/dist" ]; then
              echo "‚ùå Error: Missing dist folder for $pkg_name"
              exit 1
            fi
            echo "‚úÖ $pkg_name: dist folder exists"
          done

          echo "Checking for suspicious files in dist folders..."
          if find packages/*/dist -type f \( -name "*.sh" -o -name "*.exe" -o -name "*.bat" -o -name "*.cmd" \) | grep -q .; then
            echo "‚ùå Error: Found suspicious executable files in dist folders"
            find packages/*/dist -type f \( -name "*.sh" -o -name "*.exe" -o -name "*.bat" -o -name "*.cmd" \)
            exit 1
          fi
          echo "‚úÖ No suspicious files found"

          echo "Verifying package sizes are reasonable..."
          for dist_dir in packages/*/dist; do
            size=$(du -sh "$dist_dir" | cut -f1)
            echo "  $(basename $(dirname $dist_dir)): $size"
          done

      - name: Run release-it (version, git, npm publish)
        id: release
        if: inputs.dry_run == false
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
          NPM_CONFIG_TAG: ${{ steps.release-params.outputs.tag }}
        run: |
          pnpm exec release-it ${{ steps.release-params.outputs.release_increment }} ${{ steps.release-params.outputs.pre_release_flag }} --ci --config .release-it.ci.json

      - name: Run release-it (dry run)
        if: inputs.dry_run == true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
          NPM_CONFIG_TAG: ${{ steps.release-params.outputs.tag }}
        run: |
          echo "üß™ Running in DRY RUN mode - no changes will be pushed"
          pnpm exec release-it ${{ steps.release-params.outputs.release_increment }} ${{ steps.release-params.outputs.pre_release_flag }} --ci --config .release-it.ci.json --dry-run

      - name: Get version
        id: version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Create release artifacts archive
        if: inputs.dry_run == false
        run: |
          mkdir -p release-artifacts
          for pkg in packages/*/dist; do
            pkg_name=$(basename $(dirname $pkg))
            echo "Creating archive for $pkg_name..."
            tar -czf release-artifacts/langfuse-js-sdk-${pkg_name}-${{ steps.version.outputs.version }}.tar.gz -C $(dirname $pkg) dist
          done
          echo "Build artifacts:"
          ls -lh release-artifacts/

      - name: Upload release artifacts to GitHub Release
        if: inputs.dry_run == false
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          files: release-artifacts/*.tar.gz
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}

      - name: Notify Slack on success
        if: success() && inputs.dry_run == false
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "‚úÖ Langfuse JS/TS SDK v${{ steps.version.outputs.version }} published to npm",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ Langfuse JS/TS SDK Released",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n`v${{ steps.version.outputs.version }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*npm Tag:*\n`${{ steps.release-params.outputs.tag }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Released by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Packages:*\n6 packages published"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üì¶ Published Packages:*\n‚Ä¢ `@langfuse/client`\n‚Ä¢ `@langfuse/core`\n‚Ä¢ `@langfuse/tracing`\n‚Ä¢ `@langfuse/otel`\n‚Ä¢ `@langfuse/openai`\n‚Ä¢ `@langfuse/langchain`"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üìã View Release Notes",
                        "emoji": true
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}",
                      "style": "primary"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üì¶ View on npm",
                        "emoji": true
                      },
                      "url": "https://www.npmjs.com/package/@langfuse/client/v/${{ steps.version.outputs.version }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üîß View Workflow",
                        "emoji": true
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "üîí Published with provenance attestations ‚Ä¢ ü§ñ Automated release"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_RELEASES }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Notify Slack on dry run success
        if: success() && inputs.dry_run == true
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "üß™ Langfuse JS/TS SDK dry run completed for v${{ steps.version.outputs.version }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üß™ Langfuse JS/TS SDK Dry Run",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Release dry run completed successfully. No packages were published."
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n`v${{ steps.version.outputs.version }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*npm Tag:*\n`${{ steps.release-params.outputs.tag }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Mode:*\nDry run (testing only)"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üîß View Workflow",
                        "emoji": true
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "style": "primary"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üìÅ View Repository",
                        "emoji": true
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "‚ÑπÔ∏è This was a test run. To publish, re-run without dry run mode."
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_ENGINEERING }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Notify Slack on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "‚ùå Langfuse JS/TS SDK release workflow failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå Langfuse JS/TS SDK Release Failed",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ö†Ô∏è The release workflow encountered an error and did not complete successfully."
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Requested Version:*\n`${{ inputs.version }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Pre-release Type:*\n${{ inputs.prerelease_type || 'N/A' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Dry Run:*\n${{ inputs.dry_run }}"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üîç Next Steps:*\n‚Ä¢ Check the workflow logs for error details\n‚Ä¢ Verify all prerequisites are met\n‚Ä¢ Check npm Trusted Publishing configuration\n‚Ä¢ Verify Slack webhook secrets are set"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üîß View Workflow Logs",
                        "emoji": true
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "style": "danger"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üìñ View Documentation",
                        "emoji": true
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/blob/main/CONTRIBUTING.md"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "üö® Action required ‚Ä¢ Check workflow logs for details"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_ENGINEERING }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Rollback notification on partial failure
        if: failure() && steps.release.outcome == 'success'
        run: |
          echo "‚ö†Ô∏è  CRITICAL: Release succeeded but subsequent steps failed"
          echo "Published version: v${{ steps.version.outputs.version }}"
          echo "Manual intervention may be required"
          echo ""
          echo "Options:"
          echo "1. Re-run the workflow to complete GitHub release artifacts upload"
          echo "2. Manually upload release artifacts for tag v${{ steps.version.outputs.version }}"
